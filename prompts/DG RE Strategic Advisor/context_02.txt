I’m sending a long context. Do not reply until I write: READY. Just acknowledge received.

# DG RE — Canonical Domain Laws (v0.1, Research & Simulation-Oriented)

> **Scope**
> These laws define **non-negotiable invariants** of the DG Risk Engine.
> Any violation is a **modeling or simulation-blocking defect**.
> Experimental behavior is allowed **only outside validated simulations**.

---

## 0. System Design Principles (Global)

These principles apply to **every service, simulation module, and risk model**.

### 0.1 Architectural Principles

* **Single Responsibility (SRP):** each module implements exactly one risk or strategy function.
* **Explicit Contracts:** `.proto` files are the only source of truth for API requests/responses.
* **Loose Coupling:** risk modules communicate only via versioned APIs/events.
* **High Cohesion:** game-theoretic logic never leaks outside module boundaries.

### 0.2 Operational Principles

* **All operations are idempotent.**
* **All state transitions are explicit and auditable.**
* **All modules are containerized and stateless** (except storage).
* **Failure is expected; undefined dynamics are forbidden.**

---

## 1. RiskState Domain Laws

### 1.1 Purpose

`RiskState` represents **current risk conditions** for agents and the platform, not actual financial commitments.

### 1.2 Invariants

1. Each agent may have **multiple risk components** (driver_risk, passenger_risk, platform_risk).
2. Risk states are **always bounded** (e.g., [0,1]).
3. State updates are **explicitly defined via transitions**.
4. Unserviceable or out-of-scope scenarios **must fail fast** with explicit reason codes.
5. State rollback must be possible in simulations.

### 1.3 Idempotency

* Idempotency key:

  ```
  risk_state:{agent_id}:{timestamp}
  ```
* Repeated updates:

  * return existing state, or
  * deterministically recompute via defined policy.

### 1.4 Cold-Start Handling

* If no agent history exists:

  * Synthetic risk defaults applied
  * Uncertainty explicitly modeled
* No arbitrary imputation without explanation.

---

## 2. Agent & Platform Domain Laws (FSM-Enforced)

### 2.1 Purpose

`Agent` and `PlatformPolicy` represent **strategic decision-making units**.

### 2.2 Creation Rules

1. An `Agent` **MUST have an initial risk state**.
2. Platform policy **MUST reference valid agent states**.
3. Agent and platform updates **are idempotent by simulation step ID**.
4. Immutable fields:

   * agent_id
   * agent type (driver/passenger)
   * creation timestamp (UTC)

### 2.3 Lifecycle (FSM — mandatory)

`Agent` **MUST** follow a **Finite State Machine**:

```
AVAILABLE → ENGAGED → COMPLETED
AVAILABLE → INACTIVE
ENGAGED → COMPLETED
```

Any other transition:

* rejected
* logged
* counted as protocol violation

### 2.4 Failure Handling

* Unexpected agent dropout:

  * transition → `INACTIVE`
  * platform notified
  * optional auto-recalculation of risk

---

## 3. RiskEvaluationService Laws (Pure, Deterministic)

### 3.1 Responsibility

RiskEvaluationService is a **pure computation engine**.

It:

* computes agent risk scores
* predicts platform exposure
* never mutates system state directly

### 3.2 Determinism

For identical inputs + seed:

* identical risk vectors
* identical policy suggestions
* identical ordering of recommendations

### 3.3 Constraints

1. Only **active agents** are considered.
2. Candidate set size for intervention is bounded (`max_agents`).
3. Risk scores:

   * normalized (sum or range defined)
   * immutable once computed

### 3.4 Failure Behavior

* Empty candidate set → explicit reason code
* Crashes or timeouts → safe retry with same input and seed

---

## 4. API Gateway / Orchestration Laws

### 4.1 Responsibilities

API Gateway:

* orchestrates simulation and real-time queries
* enforces idempotency
* logs decisions and outputs

### 4.2 Sampling / Stochasticity

* Randomized simulation or stochastic elements occur **only here**
* Seed-based determinism is enforced
* Probabilities never modified after computation

### 4.3 Reliability

* Retry-safe by design
* No direct risk state mutation outside RiskEvaluationService
* Failed computation:

  * retried idempotently, or
  * queued for async recalculation

---

## 5. Agent Laws

1. An agent may participate in **only one active strategic engagement** at a time.
2. Only agents marked **ACTIVE** are included in evaluation.
3. Agent connectivity or dropout:

   * agent marked INACTIVE
   * in-progress engagements handled by FSM
4. Risk state is **derived**, not inferred without explicit model

---

## 6. Eventing & Telemetry Laws

### 6.1 Event Model

* Events are **append-only**
* Events are **fail-safe**
* Event duplication allowed; side effects must be idempotent

### 6.2 Mandatory Telemetry

Logged for every critical operation:

* RiskState updates
* Agent FSM transitions
* Policy outputs
* Failures, retries, cancellations

### 6.3 Replayability

* Any incident must be reproducible via event replay
* Sampling seeds are persisted

---

## 7. Probabilistic & ML Laws

1. Risk outputs are immutable training data.
2. All computations are replayable via seed.
3. Cold-start uncertainty explicitly tracked.
4. Data drift monitored continuously.
5. Retraining or model updates triggered only by **metric degradation**, not intuition.

---

## 8. High Availability & Risk Governance Laws

### 8.1 Availability

* No single point of failure
* Stateless services + replicated storage
* Leader election and failover supported

### 8.2 Data Safety

* Databases must support:

  * replication
  * backups
  * transactional guarantees
* Idempotency enforced at storage level

### 8.3 Performance & SLAs

* Latency budgets defined per service
* RiskEvaluationService must degrade gracefully under load
* Slowdowns must be observable before compromising recommendations

---

## 9. Deployment & Governance

1. Generated code is **never edited manually**

2. Invariants enforced by:

   * unit tests
   * integration tests
   * simulation replay tests

3. Failed tests = **deployment blocked**

4. Versioned APIs only; breaking changes require migration plans
